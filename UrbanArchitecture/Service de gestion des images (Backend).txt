// src/modules/images/services/image.service.ts
@Injectable()
export class ImageService {
  constructor(
    @InjectCloudinary() private cloudinary: Cloudinary,
    private prisma: PrismaService,
  ) {}

  // Téléverser une image sur Cloudinary
  async uploadImage(file: Express.Multer.File): Promise<Image> {
    const uploadResult = await this.cloudinary.uploader.upload(file.path);
    
    return this.prisma.image.create({
      data: {
        url: uploadResult.secure_url,
        type: ImageType.UPLOADED
      }
    });
  }

  // Ajouter une image depuis une URL
  async addImageFromUrl(url: string): Promise<Image> {
    // Valider l'URL
    if (!this.isValidImageUrl(url)) {
      throw new BadRequestException('URL d\'image invalide');
    }

    return this.prisma.image.create({
      data: {
        url,
        type: ImageType.URL
      }
    });
  }

  // Valider une URL d'image
  private isValidImageUrl(url: string): boolean {
    try {
      const parsedUrl = new URL(url);
      const extension = path.extname(parsedUrl.pathname).toLowerCase();
      return ['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(extension);
    } catch {
      return false;
    }
  }
}